<!-- A FAIRE ENCORE
SUPPRESSION GROUPE : ne pas compter comme une tache en moins quand une tache arrivant dans parking
					 en provient.
FUSION : Afficher les tâches concernées par la fusion dans le popup.
		Gérer pour ne pas mettre la tâche initiatrice de la fusion dans la boucle each
		pour que même si elle se superpose il y ai fusion !! FAIT !!
Probleme de z-index : les taches draggés passant par en dessous c'est moche : => rectifié !
pour les fusions de gauche à droite : le drop d'une tache doit pas engendrer le déplacement des autres sinon comparaison
des coordonnées impossible: Fait (position absolute) !
Bouger les groupes, est-ce nécessaire ?
que l'on puisse poser les tâches n'importe ou ?
DU CSS, plein de CSS
-->
<!DOCTYPE html>
<html lang='fr'>
	<head>

		<meta charset='utf-8'>
		<link href='style2.css' rel='stylesheet'>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Drag and drop 3</title>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js"></script>
		<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/themes/smoothness/jquery-ui.css">

		<script type"text/javascript">
$(function(){

    $('.groupe').draggable({ containment: 'parent' }); // appel du plugin
    $('.tache').draggable({ containment: 'parent',/*, helper: "clone"*/
				start: function( event, ui){
					ui.helper.css("z-index", "5"); // les taches draggées ne passent plus en dessous des autres
				},
				stop: function(event, ui){
					ui.helper.css("z-index", "2");
				} }); 
var compteur = 0;
var nbtache = 0;
var mintopgroup = 0;
var minleftgroup = 0;
var maxtopgroup = 0;
var maxleftgroup = 0;
var hauteurtacheplusdix = parseInt($('.tache').css('height')) + 10;
var tailleInitiale = parseInt($('#groupe1').css('height'));


    $('#groupe1').droppable({

		        drop: function( event, ui ) {   // Action effectuée lorsqu'on dépose un élément dans le groupe
		            // ui.draggable désigne l'élément déplacé		                  
		            ui.draggable.appendTo( $(this) ) // on le met à l'intérieur du groupe
		            		.css({                     
                    			left: '5%',
                    			top:  '5%'
               				})
               		ui.draggable.addClass('ingroupe');
               				compteur = compteur + 1;

               		//récupération des positions de la derniere tache déposée
               		var divlastposition = $('#groupe1 div:last-child').position();
               		//hauteur du groupe pas mettre en globale sinon les mises à jour ne servent à rien
					var hauteurgroupe = parseInt($('#groupe1').css('height'));

               		// Si la tache va se déposer en dehors du groupe, on agrandit le groupe
					if(divlastposition.top+50 >  hauteurgroupe){ 
						$("#groupe1").animate({height: '+='+hauteurtacheplusdix},500);
						hauteurgroupe = parseInt($('#groupe1').css('height')); // mise à jour de hauteur groupe
				//		alert(hauteurgroupe);
					}
					//probleme fonctionne mais pas au bon moment, quand on ajoute une nouvelle tache
					if(hauteurgroupe > tailleInitiale && hauteurgroupe - (divlastposition.top+50) > hauteurtacheplusdix){ //150 
						$("#groupe1").animate({height: '-='+hauteurtacheplusdix},500);
						hauteurgroupe = parseInt($('#groupe1').css('height'));
					}            	

					}
		        

}); 

    $('#parking').droppable({
		        drop: function( event, ui ) {   // Action effectuée lorsqu'on dépose un élément dans le parking

		            ui.draggable.appendTo( $(this) ) // on le met à l'intérieur du groupe
		            		.css({                     
                    			position: 'absolute'
                    			
               				});

		//			var objet_drop = $(ui.draggable); // L'élément drop
           			var id_objet = ui.draggable.attr('id'); // ID de l'élément drop 
           		//	alert(ui.draggable);
            	//	alert(ui.helper);
          			
          			// si l'élément arrivant dans la zone drop parking provient du groupe 
          			// on ote 1 au compteur du groupe
           			if(ui.draggable.hasClass('ingroupe')){
               			compteur = compteur -1 ;
               			if(compteur == 0){
					   		$( "#groupe1" ).remove();
               			}
               			ui.draggable.removeClass('ingroupe');
               		}

          		var hauteurgroupe = parseInt($('#groupe1').css('height'));
           		var divlastposition = $('#groupe1 div:nth-last-child(2)').position();
         // 		var positionaulacher = ui.draggable.position();
         //  		positionaulacherleft = positionaulacher.left;
         //  		positionaulachertop = positionaulacher.top;
          // 		alert('left ' + positionaulacherleft + ' top ' + positionaulachertop);

					if(hauteurgroupe > tailleInitiale && hauteurgroupe - (divlastposition.top+50) > hauteurtacheplusdix){ //150 
						$("#groupe1").animate({height: '-='+hauteurtacheplusdix},500);
						hauteurgroupe = parseInt($('#groupe1').css('height'));
					}
					//fusion => creation d'un groupe
					// comparaison des coordonnées de l'élément actuellement draggé avec toutes les tâches
					// si difference de top et left inférieure à 25 création, sinon non, 
					$('#parking > div.tache:not(#'+id_objet+')').each(function(){
				//		var fusion = false;
						var left = $(this).offset().left;
						var top = $(this).offset().top;
						var idtachefusion = $(this).attr('id');
				//		alert(' 1 : ' +idtachefusion);
				//		alert('left tachedraggée : ' + ui.offset.left + 'top tachedraggée : ' + ui.offset.top + 'left boucletache : ' + left + 'top boucletache : ' + top);
					//	alert('ecart gauche : ' + Math.abs(left - ui.position.left) + 'ecartTop : ' + Math.abs(top - ui.position.top));
				//	alert($(this).attr('id') + ' left : ' + left + ' ui.offset.left ' + ui.offset.left + ' top : ' + top + '  ui.offset.top : ' + ui.offset.top)
						if( Math.abs(left - ui.offset.left) < 25 && Math.abs(top - ui.offset.top) < 25){
				            	$('#popup').css('display', 'block');
				           		ui.draggable.appendTo('#popup').css({                     
                    			position: 'relative',
                    			left: '5%',
                    			top: '5%'
               				});
				      //     								alert(' 2 : ' + idtachefusion);
 
				        //   		alert('#'+idtachefusion);
				          		$('#'+idtachefusion).appendTo('#popup').css({                     
                    			position: 'relative',
                    			left: '5%',
                    			top: '5%'
               				});
				          		return false;
				           		}
				          // 		var fusion = true;
            					
 //							           		$(this).appendTo('#popup');	

					});
							}
		            	});



});
		</script>

		<script type="text/javascript">
				        function fermepopup(){
            		$('#popup').css('display', 'none');
            	};
            	</script>	

	</head>
	<body>

		<a href="#" class="myButton" id="newtask">Nouvelle tâche</a>
		<a href="#" class="myButton" id="changetask">Modifier tâche</a>
		<a href="#" class="myButton" id="deletetask">Supprimer tâche</a>

<div id="parking">
<div id="tache1" class="tache">
tache1
</div>	
<div id="tache2" class="tache">
tache2
</div>	
<div id="tache3" class="tache">
tache3
</div>	
<div id="tache4" class="tache">
tache4
</div>	
<div id="tache5" class="tache">
tache5
</div>	
<div id="tache6" class="tache">
tache6
</div>	
<div id="tache7" class="tache">
tache7
</div>	
<div id="tache8" class="tache">
tache8
</div>	
<div id="tache9" class="tache">
tache9
</div>	
<div id="popup">
	<img id="fermeture" onclick="fermepopup()"src="../img/fermeture.png" alt="icone fermeture popup" />
<h1 id="titrefusion">Fusion de tâches </h1>
<input type="text" placeholder="Nom du groupe" />
<input type="submit" value="valider"/>
</div>
<div id="groupe1" class="groupe">
<p>groupe1</p>
</div>

</div>

	</body>
</html>